<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Provision Virtual Edge Devices Using Cloud Images and Cloud-Init :: Provisioning Red Hat Device Edge Systems with Image Mode for RHEL</title>
    <link rel="prev" href="s1-cloud-init.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Provisioning Red Hat Device Edge Systems with Image Mode for RHEL</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/rhde-bootc-provision/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rhde-bootc-provision" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Provisioning Red Hat Device Edge Systems with Image Mode for RHEL</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../LABENV/index.html">Lab Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch1-bib/index.html">Introduction to Bootc Image Builder with Red Hat Device Edge</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-bib/s1-bootc-image-builder.html">Provision Edge Devices Using Bootc Container Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-bib/s2-prereqs-quiz.html">Review of Bootc Container Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch1-bib/s3-prereqs-lab.html">Lab: Prepare to Build and Deploy Bootc Container Images</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../ch2-iso/index.html">Build Custom RHEL Installation Media Using Image mode for RHEL</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-iso/s1-bib-iso.html">Provision Edge Devices Using the RHEL Installer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ch2-iso/s2-bib-lab.html">Lab: Provision Edge Devices Using Custom Installation Media</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Build System Images for Clouds and Hypervisors Using Image Mode for RHEL</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s1-cloud-init.html">Provision Virtual Edge Devices Using Cloud Images</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s2-vm-lab.html">Lab: Provision Virtual Edge Devices Using Cloud Images and Cloud-Init</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Provisioning Red Hat Device Edge Systems with Image Mode for RHEL</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Provisioning Red Hat Device Edge Systems with Image Mode for RHEL</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../samples/1/index.html">samples</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../samples/1/index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Provisioning Red Hat Device Edge Systems with Image Mode for RHEL</a></li>
    <li><a href="index.html">Build System Images for Clouds and Hypervisors Using Image Mode for RHEL</a></li>
    <li><a href="s2-vm-lab.html">Lab: Provision Virtual Edge Devices Using Cloud Images and Cloud-Init</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Provision Virtual Edge Devices Using Cloud Images and Cloud-Init</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>12 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Create custom cloud images for virtual edge devices, by using bootc image builder, and perform day-1 configuration of those virtual devices using cloud-init.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Work in progress
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_you_begin"><a class="anchor" href="#_before_you_begin"></a>Before you Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need a <em>development machine</em> running RHEL, to which you have unrestricted sudo access.
The <em>development machine</em> has access to mirrors of RHEL package repositories and bootc container images.</p>
</div>
<div class="paragraph">
<p>These instructions were tested on RHEL 10.0 but should work with minimal or no changes on newer and older RHEL releases, since 9.6.</p>
</div>
<div class="paragraph">
<p>If you are using the course classroom, log in on the <code>workstation</code> VM as the user <code>student</code> with password <code>student</code>.
If not, please adapt the instructions to your test environment.</p>
</div>
<div class="paragraph">
<p>Make sure you verified your test environment by following the <a href="#TBD">first lab</a> of this course.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Prepare to start this activity by checking that you have the outcomes from previous activities.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If needed, create a local clone of the sample code repository of this course, but do NOT enter its directory.
Stay on your home directory to start this lab.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>cd</strong>
$ <strong>git clone https://github.com/RedHatQuickCourses/rhde-bootc-samples.git</strong>
Cloning into 'rhde-bootc-samples'...
...</code></pre>
</div>
</div>
</li>
<li>
<p>If needed, login to your private registry.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>podman login -u student -p redhat registry.lab.example.com:5000</strong>
Login Succeeded!</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that you have a bootc container image named <code>httpd-system:v1.0</code> in your private container registry.
If you do not, please perform the <a href="#TBD">first lab</a>, which builds and publishes that image.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>skopeo inspect --format '{{ json .RepoTags }}' docker://registry.lab.example.com:5000/httpd-system:v1.0</strong>
["v1.0"]</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that you have access to libvirt through its session interface.
If you do not, please perform the preparation tasks from the <a href="#TBD">first lab</a>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>virsh list --all</strong>
 Id   Name   State
--------------------</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is fine if you have some local VMs on your system, as long as there are no VMs named <code>bootc-qcow2</code> or <code>bootc-cloud-init</code>.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Prepare scripts and configuration files you will use to automate creating and testing a VM image in the Qcow2 format.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create a working directory and copy the sample files to it.
Then make the temporary working directory your current directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>cd</strong>
$ <strong>mkdir temp-test-qcow2</strong>
$ <strong>cp rhde-bootc-samples/bib-qcow2/* temp-test-qcow2</strong>
$ <strong>cd temp-test-qcow2</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Review the example bootc image builder TOML file named <code>config.toml</code>.</p>
<div class="paragraph">
<p>It creates an initial user, so we can access VMs created from it and perform on-boarding.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">[[customizations.user]]
name = "core"
password = "redhat123"
key = "REPLACE_WITH_SSH_PUB_KEY"
groups = ["wheel"]</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The TOML file provides no network customizations.
You cannot perform them with bootc image builder, you must either use another day-1 customization technology, or have the network settings in your bootc container image.
As it is, RHEL defaults to dynamic network configuration using DHCP, which is fine for the <em>test VM</em> you will create.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Review the cloud-init configuration file named <code>user-data</code>.</p>
<div class="paragraph">
<p>It configures the default <code>cloud-init</code> user, and also sets a hostname.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You do NOT need to provide day-1 customizations using both bootc image builder and cloud-init. Only one of them would suffice.
We are doing both here to demonstrate that your bootc container image must include cloud-init, if you want to use it.
If you only provide customizations using cloud-init, right now, it would fail and your <em>test VM</em> would be inaccessible.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">#cloud-config
password: redhat456
chpasswd: {expire: False}
ssh_pwauth: True
ssh_authorized_keys:
  - REPLACE_WITH_SSH_PUB_KEY
bootcmd:
  - echo "bootc-cloud-init" &gt; /etc/hostname
  - chmod 644 /etc/hostname</code></pre>
</div>
</div>
</li>
<li>
<p>Review the <code>bib-qcow2.sh</code> script which invokes the bootc image builder utility, and which takes the former file as input.</p>
<div class="paragraph">
<p>Make sure you can distinguish between command-line options and arguments for Podman from command-line options and arguments for bootc image builder.</p>
</div>
<div class="openblock">
<div class="content">
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Podman runs a privileged container, with access to the root user container storage, the TOML file, and the output directory, just like in the previous lab.</p>
</li>
<li>
<p>Boootc image builder generates a Qcow2 image from the <code>bootc-httpd:v1.0</code> bootc container image, using the TOML file to perform day-1 customizations on the Qcow2 image.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">#!/bin/bash
set -xeuo pipefail

sudo podman run --rm -it --privileged --pull=newer \
    --security-opt label=type:unconfined_t \
    -v /var/lib/containers/storage:/var/lib/containers/storage \
    -v $(pwd)/config.toml:/config.toml \
    -v $(pwd)/output:/output \
    registry.lab.example.com:5000/rhel10/bootc-image-builder \
    --type qcow2 --local --config /config.toml \
    registry.lab.example.com:5000/httpd-system:v1.0</code></pre>
</div>
</div>
</li>
<li>
<p>Review the <code>virt-install.sh</code> script which creates a test VM.</p>
<div class="paragraph">
<p>It is designed to be run in text mode, so you do not need to switch to a graphical console or remote desktop session just to view the test VM boot screens, by setting the following options:</p>
</div>
<div class="openblock">
<div class="content">
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>It creates a VM with 2 vCPUs, 4096 memory, and using the user mode networking stack, forwarding ports 8080 and 8022 to enable access to the Apache Web Server and the SSH server.</p>
</li>
<li>
<p>It uses an existing Qcow2 VM image (<code>--import</code>) instead of creating a new image and installing an operating system.</p>
</li>
<li>
<p>It also provides a cloud-init user data file (<code>--cloud-init</code>).</p>
</li>
</ol>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">#!/bin/bash
set -xeuo pipefail

virt-install --name bootc-qcow2 \
--vcpus 2 --memory 4096 \
--disk httpd-system.qcow2,size=20 \
--import \
--network passt,portForward0=8022:22,portForward1=8080:80 \
--os-variant rhel10.0 \
--graphics=none \
--cloud-init user-data=user-data</code></pre>
</div>
</div>
</li>
<li>
<p>Create an SSH key for use with your <em>test VM</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ssh-keygen -N '' -f edge-key -C 'initial key for edge devices'</strong>
Generating public/private rsa key pair.
...</code></pre>
</div>
</div>
</li>
<li>
<p>Alternatively, you could just copy the SSH key files from the previous lab.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>cp ../temp-test-iso/edge-key* .</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Embed the SSH key it in your TOML file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>SSH_PUB_KEY=$( cat edge-key.pub )</strong>
$ <strong>sed -i "s|REPLACE_WITH_SSH_PUB_KEY|$SSH_PUB_KEY|" config.toml</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Embed the SSH key it in your cloud-init user data file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sed -i "s|REPLACE_WITH_SSH_PUB_KEY|$SSH_PUB_KEY|" user-data</strong></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Create a custom VM image in Qcow format.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Log in again on your private registry, but this time as the root user.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo podman login -u student -p redhat registry.lab.example.com:5000</strong>
Login Succeeded!</code></pre>
</div>
</div>
</li>
<li>
<p>Download the bootc container image to the container storage of the root user.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo podman pull registry.lab.example.com:5000/httpd-system:v1.0</strong>
...
Writing manifest to image destination
...</code></pre>
</div>
</div>
</li>
<li>
<p>Create an output directory for the bootc image builder utility.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>mkdir output</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Invoke the script which runs the bootc image builder utility.</p>
<div class="paragraph">
<p>Be patient, it takes several minutes running.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>bash bib-qcow2.sh</strong>
...
Message: Results saved in .</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the installable ISO from the bootc image builder output directory to a more permanent location, and give it an easily identifiable name.
That file would be distributed to personel responsible for installing actual edge devices.</p>
<div class="paragraph">
<p>Make sure the file name matches the one expected by the <code>virt-install.sh</code> script.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>cp output/qcow2/disk.qcow2 httpd-system.qcow2</strong></code></pre>
</div>
</div>
</li>
<li>
<p>If you need to rebuild your installation ISO, for whatever reason, we recommend that you first clean your bootc image builder output directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo rm -rf output/</strong>*</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Create a local VM, using the Qcow2 image.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Invoke the script which creates a <em>test VM</em> from the qcow2 image.</p>
<div class="paragraph">
<p>After the installation is complete and the VM reboots, dettach from its virtual serial console using <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>bash virt-install.sh</strong>
Starting install...
Creating domain...
...
Red Hat Enterprise Linux 10.0 (Coughlan)
Kernel 6.12.0-55.24.1.el10_0.x86_64 on x86_64

enp1s0: 172.25.250.9 fe80::87ba:fa4d:5761:7e8b
workstation login:</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The hostname of your <em>test VM</em> should be <code>workstation</code>, which is a sign that the cloud-init customizations were NOT performed.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If something goes wrong and you have to retry creating your VM, first stop and delete it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>virsh destroy bootc-qcow2</strong>
Domain 'bootc-qcow2' destroyed
$ <strong>virsh undefine bootc-qcow2 --remove-all-storage</strong>
Domain 'bootc-qcow2' has been undefined
Volume 'vda'(/home/student/.local/share/libvirt/images/bootc-qcow2.qcow2) removed.</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The <code>--remove-all-storage</code> deletes the Qcow2 file which boots the VM, so it is important to NOT use the copy in the <code>output</code> directory.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Verify that the test VM runs a web server with the mock web application files, but was NOT customized by cloud-init, and it is NOT running a guest agent either.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Use the SSH key to access your <em>test VM</em> as the <code>core</code> user, configured by bootc image builder.</p>
<div class="paragraph">
<p>If you performed the previous lab, you must first remove the existing key from your known hosts file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ssh-keygen -R '[127.0.0.1]:8022'</strong>
# Host [127.0.0.1]:8022 found: line 11
/home/student/.ssh/known_hosts updated.
Original contents retained as /home/student/.ssh/known_hosts.old
$ <strong>ssh -i edge-key -p 8022 core@127.0.0.1</strong>
...
[core@workstation ~]$</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that your <em>test VM</em> was provisioned using image mode.
The password for the <code>core</code> user is <code>redhat123</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo bootc status</strong>
● Booted image: registry.lab.example.com:5000/httpd-system:v1.0
        Digest: sha256:068dc70b8eca43a0fa3c4a436d7098305898e5235c677f489b69ddc370885f6d
       Version: 10.0 (2025-08-15 21:23:47.500494502 UTC)</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the Apache Web Server is active is your <em>test VM</em> and it contains the files of the mock web application.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>systemctl is-active httpd</strong>
active
$ <strong>curl 127.0.0.1</strong>
Misc tests of bootc images and firewalld</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that this VM does NOT have cloud-init installed.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>systemctl is-active cloud-init</strong>
inactive
$ <strong>rpm -q cloud-init</strong>
package cloud-init is not installed</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that your <em>test VM</em> does NOT have a QEMU guest agent either, and terminate its SSH session.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>systemctl is-active qemu-guest-agent</strong>
inactive
$ <strong>rpm -q qemu-guest-agent</strong>
package qemu-guest-agent is not installed
$ <strong>exit</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the host can access the mock web application, through  port-forwarding, similar to how SSH access works.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl 127.0.0.1:8080</strong>
Misc tests of bootc images and firewalld</code></pre>
</div>
</div>
</li>
<li>
<p>Use the SSH key to access your <em>test VM</em> as the <code>cloud-user</code> user, which should have been configured by cloud-init.</p>
<div class="paragraph">
<p>If you performed the previous lab, you must first remove the existing key from your known hosts file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ssh -i edge-key -p 8022 cloud-user@127.0.0.1</strong>
cloud-user@127.0.0.1's password:
Permission denied, please try again.
cloud-user@127.0.0.1's password:
Permission denied, please try again.
cloud-user@127.0.0.1's password:
cloud-user@127.0.0.1: Permission denied (publickey,gssapi-keyex,gssapi-with-mic,password).</code></pre>
</div>
</div>
</li>
<li>
<p>Using the <code>redhat456</code> password for the <code>cloud-user</code> user would not work either.
The fact that you cannot log in as <code>cloud-user</code> and the hostname was not changed to <code>bootc-cloud-init</code> are signs that cloud-init was not running on your <em>test VM</em></p>
</li>
<li>
<p>Verify that your local hypervisor cannot get information about the operating system inside your <em>test VM</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>virsh guestinfo bootc-qcow2</strong>
error: Guest agent is not responding: QEMU guest agent is not connected</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Stop your <em>test VM</em>, so you can create a new one with supports cloud-init and the QEMU guest agent.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>virsh destroy bootc-qcow2</strong>
Domain 'bootc-qcow2' destroyed</code></pre>
</div>
</div>
</li>
<li>
<p>Create a bootc container image with cloud-init and guest agent services.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Copy the files and scripts you will use to build a new bootc container image and a new <em>test VM</em>, overwriting the files you already have on your <code>temp-test-qcow2</code> directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>cp ../rhde-bootc-samples/bib-cloud-init/* .</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Review the new containerfile.</p>
<div class="paragraph">
<p>It installs the <code>cloud-init</code> and <code>qemy-guest-agent</code> packages and enable their respective Systemd units, over the <code>httpd-system</code> bootc container image.
This way, you get shorter image build and copy times.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">FROM registry.lab.example.com:5000/httpd-system:v1.0
RUN dnf -y install cloud-init qemu-guest-agent &amp;&amp; \
  systemctl enable cloud-init &amp;&amp; \
  systemctl enable qemu-guest-agent &amp;&amp; \
  dnf clean all</code></pre>
</div>
</div>
</li>
<li>
<p>Review the new <code>bib-qcow2.sh</code> script.</p>
<div class="paragraph">
<p>It only changes the name of the bootc container image used by bootc image builder to <code>httpd-cloud-init:v1.0</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">#!/bin/bash
set -xeuo pipefail

sudo podman run --rm -it --privileged --pull=newer \
    --security-opt label=type:unconfined_t \
    -v /var/lib/containers/storage:/var/lib/containers/storage \
    -v $(pwd)/config.toml:/config.toml \
    -v $(pwd)/output:/output \
    registry.lab.example.com:5000/rhel10/bootc-image-builder \
    --type qcow2 --local --config /config.toml \
    registry.lab.example.com:5000/httpd-cloud-init:v1.0</code></pre>
</div>
</div>
</li>
<li>
<p>Review the new <code>virt-install.sh</code> script.</p>
<div class="paragraph">
<p>It changes the name of the VM to <code>bootc-cloud-init</code> and of its VM image file to <code>httpd-cloud-init.qcow2</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">#!/bin/bash
set -xeuo pipefail

virt-install --name bootc-cloud-init \
--vcpus 2 --memory 4096 \
--disk httpd-cloud-init.qcow2,size=20 \
--import \
--network passt,portForward0=8022:22,portForward1=8080:80 \
--os-variant rhel10.0 \
--graphics=none \
--cloud-init user-data=user-data</code></pre>
</div>
</div>
</li>
<li>
<p>Build a new bootc container image and push it to the private registry.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>podman build -t httpd-cloud-init .</strong>
...
Successfully tagged localhost/httpd-cloud-init:latest
a2043f0dc07887ddf1b82ea0dfd45120f0b56c8c3b28914f4b34bb7b46633c30
$ <strong>skopeo copy containers-storage:localhost/httpd-cloud-init docker://registry.lab.example.com:5000/httpd-cloud-init:v1.0</strong>
...
Writing manifest to image destination</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Create a new <em>test VM</em> using the new bootc container image.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Download the new bootc container image to the root user and build a new qcow2 image from it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo podman pull registry.lab.example.com:5000/httpd-cloud-init:v1.0</strong>
...
Writing manifest to image destination
a2043f0dc07887ddf1b82ea0dfd45120f0b56c8c3b28914f4b34bb7b46633c30
$ <strong>sudo rm -rf output/</strong>*
$ <strong>bash bib-qcow2.sh</strong>
...
Message: Results saved in .</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the new Qcow2 image to the file name expected by the <code>virt-install.sh</code> script.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>cp output/qcow2/disk.qcow2 httpd-cloud-init.qcow2</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Create a new <em>test VM</em>.
When the VM finished boot, detach from its console using kdb:[Ctrl+C].</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>bash virt-install.sh</strong>
...
[  OK  ] Reached target cloud-init.target - Cloud-init target.

Red Hat Enterprise Linux 10.0 (Coughlan)
Kernel 6.12.0-55.24.1.el10_0.x86_64 on x86_64

enp1s0: 172.25.250.9 fe80::5054:ff:fe8f:94b4
bootc-cloud-init login:</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You should see the hostname change in the VM&#8217;s login prompt, as a sign that, this time, it got customizations from cloud-init.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Access your new <em>test VM</em> using the initial user created by cloud-init.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Remove the previous host key from your known hosts file and open an SSH connection, but using the <code>cloud-user</code> user instead of the <code>core</code> user.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>ssh-keygen -R '[127.0.0.1]:8022'</strong>
# Host [127.0.0.1]:8022 found: line 11
/home/student/.ssh/known_hosts updated.
Original contents retained as /home/student/.ssh/known_hosts.old
$ <strong>ssh -i edge-key -p 8022 cloud-user@127.0.0.1</strong>
...
[cloud-user@bootc-cloud-init ~]$</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that your <em>test VM</em> has active cloud-init and guest agent services, and terminate its SSH session.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>systemctl is-active cloud-init</strong>
active
$ <strong>systemctl is-active qemu-guest-agent</strong>
active
$ <strong>exit</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the mock web application is available.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>curl 127.0.0.1:8080</strong>
Misc tests of bootc images and firewalld</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that your hypervisor can now get information from the operating system inside your <em>test VM</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>virsh guestinfo bootc-cloud-init</strong>
user.count          : 0
os.id               : rhel
os.name             : Red Hat Enterprise Linux
os.pretty-name      : Red Hat Enterprise Linux 10.0 (Coughlan)
...</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The strategy demonstrated here, of layering bootc container images to add services and settings specific to a cloud provider over a more generic bootc container image, is just a suggestion.
The opposite could also work: having generic parent bootc container images for different clouds and hypervisors, and adding your applications over them.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_whats_next"><a class="anchor" href="#_whats_next"></a>What&#8217;s next</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is the final activity in this course.</p>
</div>
<div class="paragraph">
<p>The next course teaches how to update edge systems provisioned using image mode for RHEL and how to troubleshoot common issues.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="s1-cloud-init.html">Provision Virtual Edge Devices Using Cloud Images</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
